<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Laporan Kokurikulum Digital - SMA Al-Mahadul Islami</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .hidden { display: none; }
        .glass-nav { background: rgba(29, 78, 216, 0.95); backdrop-filter: blur(10px); }
        @media print { .no-print { display: none !important; } .print-only { display: block !important; } }
        
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #1d4ed8;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .modal-enter { animation: modalIn 0.3s ease-out forwards; }
        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.95) translateY(-20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .status-online { background-color: #10b981; box-shadow: 0 0 10px #10b981; }
        .status-offline { background-color: #ef4444; box-shadow: 0 0 10px #ef4444; }
        .status-pending { background-color: #f59e0b; box-shadow: 0 0 10px #f59e0b; }
    </style>
    <script>
        function toggleLoginModal(show) {
            const modal = document.getElementById('login-modal');
            if (modal) {
                if (show) {
                    modal.classList.remove('hidden');
                } else {
                    modal.classList.add('hidden');
                }
            }
        }

        function switchAppView(view) {
            const dashboard = document.getElementById('dashboard-view');
            const admin = document.getElementById('admin-view');
            if (dashboard && admin) {
                if (view === 'admin') {
                    dashboard.classList.add('hidden');
                    admin.classList.remove('hidden');
                } else {
                    admin.classList.add('hidden');
                    dashboard.classList.remove('hidden');
                }
            }
            window.scrollTo(0,0);
        }

        window.toggleLoginModal = toggleLoginModal;
        window.switchAppView = switchAppView;
    </script>
</head>
<body class="bg-slate-50 min-h-screen text-slate-900">

    <!-- Navigasi Utama -->
    <nav class="glass-nav text-white shadow-xl sticky top-0 z-40 no-print">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-4 cursor-pointer" onclick="location.reload()">
                <img src="https://i.postimg.cc/SNmZtXqv/photo-2026-01-21-21-49-29.jpg" alt="Logo Sekolah" class="w-12 h-12 object-contain bg-white rounded-full p-1 shadow-md">
                <div class="leading-tight">
                    <span class="font-bold text-xl tracking-wide block text-white uppercase">SMA AL-MAHADUL ISLAMI</span>
                    <span class="text-xs text-blue-100 opacity-80 uppercase tracking-widest font-medium">TASEK JUNJUNG</span>
                </div>
            </div>
            <div class="flex flex-col items-end">
                <div class="flex items-center space-x-6 mb-1">
                    <button onclick="switchAppView('dashboard')" class="text-sm font-bold hover:text-blue-200 transition uppercase tracking-wider">UTAMA</button>
                    <button onclick="toggleLoginModal(true)" class="bg-white/10 border border-white/20 px-5 py-2 rounded-xl hover:bg-white/20 transition flex items-center space-x-2">
                        <i data-lucide="lock" class="w-4 h-4 text-blue-200"></i>
                        <span class="text-sm font-bold uppercase">PENTADBIR</span>
                    </button>
                </div>
                <!-- Status Sambungan Real-time -->
                <div id="db-status-container" class="flex items-center bg-black/20 px-3 py-1 rounded-full border border-white/10">
                    <span id="status-dot" class="status-dot status-offline"></span>
                    <span id="status-text" class="text-[10px] font-black uppercase tracking-wider text-red-300">OFFLINE</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- UI Borang & Arkib -->
    <div id="main-content" class="container mx-auto px-4 py-10">
        <div id="dashboard-view" class="max-w-4xl mx-auto">
            <div class="text-center mb-10 no-print">
                <h1 class="text-4xl font-black text-slate-900 mb-2 tracking-tight uppercase">LAPORAN PROGRAM KO-KURIKULUM</h1>
                <p class="text-slate-500 font-medium uppercase text-xs tracking-[0.2em]">Sistem Digital SMA Al-Mahadul Islami</p>
            </div>

            <div class="bg-white rounded-3xl shadow-xl border border-slate-100 overflow-hidden">
                <div class="p-8 md:p-12">
                    <form id="laporan-form" class="space-y-8">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="md:col-span-2">
                                <label class="block text-sm font-bold text-slate-700 mb-2 uppercase">Nama Program / Unit</label>
                                <input type="text" id="nama_program" required class="w-full px-5 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none uppercase text-sm focus:ring-2 focus:ring-blue-500 transition">
                            </div>
                            <div><label class="block text-sm font-bold text-slate-700 mb-2 uppercase">Tarikh</label><input type="date" id="tarikh" required class="w-full px-5 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 transition"></div>
                            <div><label class="block text-sm font-bold text-slate-700 mb-2 uppercase">Tempat</label><input type="text" id="tempat" required class="w-full px-5 py-3 bg-slate-50 border border-slate-200 rounded-xl uppercase text-sm focus:ring-2 focus:ring-blue-500 transition"></div>
                        </div>
                        <div class="space-y-4">
                            <label class="block text-sm font-bold text-slate-700 uppercase">Laporan Aktiviti</label>
                            <textarea id="aktiviti" rows="5" required class="w-full px-5 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm uppercase focus:ring-2 focus:ring-blue-500 transition"></textarea>
                        </div>
                        <div class="space-y-4">
                            <label class="block text-sm font-bold text-slate-700 uppercase">Gambar (Maks 4)</label>
                            <input type="file" id="gambar_upload" accept="image/*" multiple class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-bold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                            <div id="preview-container" class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4"></div>
                        </div>
                        <button type="submit" id="btn-submit" class="w-full bg-blue-800 text-white font-black py-5 rounded-xl shadow-lg flex justify-center items-center text-xl uppercase tracking-wide hover:bg-blue-900 transition">
                            SIMPAN LAPORAN
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div id="admin-view" class="hidden max-w-6xl mx-auto">
            <div class="bg-white rounded-3xl shadow-xl border border-slate-100 overflow-hidden">
                <div class="p-8 border-b flex justify-between items-center bg-slate-50/50">
                    <h2 class="text-2xl font-black text-slate-900 uppercase">ARKIB LAPORAN</h2>
                    <button onclick="switchAppView('dashboard')" class="px-4 py-2 bg-white border rounded-lg font-bold text-xs uppercase">Tutup</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 text-[10px] uppercase font-black"><tr class="border-b"><th class="p-6">Tarikh</th><th class="p-6">Program</th><th class="p-6">Tempat</th><th class="p-6 text-center">Aksi</th></tr></thead>
                        <tbody id="admin-table-body" class="divide-y"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-md hidden flex items-center justify-center z-[100] p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl shadow-2xl p-8 border border-slate-200">
            <h3 class="text-center text-xl font-black text-slate-900 mb-6 uppercase">LOG MASUK ADMIN</h3>
            <div class="space-y-4">
                <input type="text" id="admin-id" class="w-full px-5 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none uppercase text-sm font-bold" placeholder="ID PENGGUNA">
                <input type="password" id="admin-pw" class="w-full px-5 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm font-bold" placeholder="KATA LALUAN">
                <button id="modal-submit-btn" class="w-full bg-blue-800 text-white font-black py-4 rounded-xl shadow-lg uppercase">MASUK</button>
                <button onclick="toggleLoginModal(false)" class="w-full text-slate-400 font-bold py-2 text-xs uppercase">BATAL</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, enableNetwork } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        let db, auth;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'koko-smami-2024';
        let base64Images = [];

        const updateStatus = (status) => {
            const dot = document.getElementById('status-dot');
            const txt = document.getElementById('status-text');
            if (!dot || !txt) return;

            if (status === 'online') {
                dot.className = "status-dot status-online";
                txt.innerText = "SISTEM ONLINE";
                txt.className = "text-[10px] font-black uppercase tracking-wider text-green-400";
            } else if (status === 'pending') {
                dot.className = "status-dot status-pending";
                txt.innerText = "MENYAMBUNG...";
                txt.className = "text-[10px] font-black uppercase tracking-wider text-amber-400";
            } else {
                dot.className = "status-dot status-offline";
                txt.innerText = "SISTEM OFFLINE";
                txt.className = "text-[10px] font-black uppercase tracking-wider text-red-400";
            }
        };

        const startFirebase = async () => {
            try {
                updateStatus('pending');
                const firebaseConfig = JSON.parse(__firebase_config);
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Paksa rangkaian untuk menyambung (Penting untuk iframe/deploy)
                await enableNetwork(db);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log("Sesi dikesan:", user.uid);
                        updateStatus('online');
                        syncData();
                    } else {
                        console.log("Tiada sesi. Memulakan login...");
                        performLogin();
                    }
                });

            } catch (err) {
                console.error("Ralat Firebase:", err);
                updateStatus('offline');
                // Cuba semula secara automatik dalam 5 saat
                setTimeout(startFirebase, 5000);
            }
        };

        const performLogin = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) {
                console.error("Ralat Login:", e);
                updateStatus('offline');
            }
        };

        const syncData = () => {
            // Menggunakan struktur path yang wajib untuk Firestore
            const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'koko_reports');
            
            onSnapshot(colRef, (snap) => {
                const list = [];
                snap.forEach(d => list.push({id: d.id, ...d.data()}));
                renderTable(list);
                updateStatus('online');
            }, (err) => {
                console.error("Ralat Sync Firestore:", err.message);
                updateStatus('offline');
                // Jika offline semasa sync, cuba aktifkan semula rangkaian
                enableNetwork(db).catch(() => {});
            });
        };

        // UI HELPERS
        document.getElementById('laporan-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-submit');
            btn.disabled = true;
            btn.innerText = "SEDANG MENYIMPAN...";

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'koko_reports'), {
                    nama: document.getElementById('nama_program').value.toUpperCase(),
                    tarikh: document.getElementById('tarikh').value,
                    tempat: document.getElementById('tempat').value.toUpperCase(),
                    aktiviti: document.getElementById('aktiviti').value.toUpperCase(),
                    imej: base64Images,
                    timestamp: new Date().toISOString()
                });
                alert("Laporan berjaya disimpan!");
                document.getElementById('laporan-form').reset();
                document.getElementById('preview-container').innerHTML = '';
                base64Images = [];
            } catch (err) {
                console.error("Ralat Simpan:", err);
                alert("Gagal menyimpan. Sila pastikan sistem berstatus ONLINE.");
            } finally {
                btn.disabled = false;
                btn.innerText = "SIMPAN LAPORAN";
            }
        });

        function renderTable(data) {
            const tbody = document.getElementById('admin-table-body');
            if (!tbody) return;
            tbody.innerHTML = '';
            data.sort((a,b) => (b.timestamp || "").localeCompare(a.timestamp || "")).forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-6 font-bold">${item.tarikh}</td>
                    <td class="p-6 font-black text-blue-900">${item.nama}</td>
                    <td class="p-6 text-slate-500">${item.tempat}</td>
                    <td class="p-6 text-center">
                        <button onclick="window.delDoc('${item.id}')" class="p-2 bg-red-50 text-red-500 rounded hover:bg-red-100 transition"><i data-lucide="trash" class="w-4 h-4"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            lucide.createIcons();
        }

        window.delDoc = async (id) => {
            if (confirm("Padam laporan ini?")) {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'koko_reports', id));
                } catch (e) {
                    alert("Ralat memadam.");
                }
            }
        };

        document.getElementById('modal-submit-btn').addEventListener('click', () => {
            const id = document.getElementById('admin-id').value;
            const pw = document.getElementById('admin-pw').value;
            if (id.toLowerCase() === "admin" && pw === "sekolah2024") {
                window.toggleLoginModal(false);
                window.switchAppView('admin');
            } else { 
                alert("ID atau Kata Laluan Salah!"); 
            }
        });

        document.getElementById('gambar_upload').addEventListener('change', (e) => {
            const preview = document.getElementById('preview-container');
            preview.innerHTML = '';
            base64Images = [];
            Array.from(e.target.files).slice(0,4).forEach(file => {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    base64Images.push(ev.target.result);
                    preview.innerHTML += `<img src="${ev.target.result}" class="w-full aspect-square object-cover rounded-xl border">`;
                };
                reader.readAsDataURL(file);
            });
        });

        startFirebase();
        window.addEventListener('DOMContentLoaded', () => lucide.createIcons());
    </script>
</body>
</html>
